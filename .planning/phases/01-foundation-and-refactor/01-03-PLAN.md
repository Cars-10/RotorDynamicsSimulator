---
phase: 01-foundation-and-refactor
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/hooks/useSimulation.ts
  - src/App.tsx
  - src/hooks/useSimulation.test.ts
autonomous: true
user_setup: []
---

<objective>
Refactor `App.tsx` by extracting simulation state, physics logic, and data generation into a custom `useSimulation` hook (Requirement ARCH-01).
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
@./.gemini/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@src/App.tsx
@src/types.ts
@src/services/geminiService.ts
</context>

<tasks>
  <task type="auto" name="create_hook">
    <file_path>src/hooks/useSimulation.ts</file_path>
    <instruction>
      Create `useSimulation` hook that manages:
      - `data` (SimulationData)
      - `activeModeIndex`
      - `isGenerating`
      - `error`
      - `isDirty`
      
      It should expose methods:
      - `generate()` (calls generateRotorData)
      - `updateSegment(index, updates)`
      - `updateSegmentWithPhysics(index, updates)` (contains the physics logic currently in App.tsx)
      - `setActiveModeIndex`
      - `setData` (for direct setting, e.g., import)
      
      Move `DEFAULT_ROTOR_DATA` import here or keep in constants, but initialize state with it.
    </instruction>
  </task>

  <task type="auto" name="test_hook">
    <file_path>src/hooks/useSimulation.test.ts</file_path>
    <instruction>
      Create unit tests for `useSimulation`:
      - Verify initial state.
      - Verify `updateSegment` updates state.
      - Verify `updateSegmentWithPhysics` triggers physics recalculation (check logic from App.tsx).
    </instruction>
  </task>

  <task type="auto" name="refactor_app">
    <file_path>src/App.tsx</file_path>
    <instruction>
      Replace local state and logic in `App.tsx` with `useSimulation` hook.
      
      Remove:
      - `useState` for data, activeModeIndex, isGenerating, error, isDirty.
      - `handleGenerate`
      - `handleUpdateSegment`
      - `handleUpdateSegmentWithPhysics`
      
      Use:
      - `const { data, activeModeIndex, generate, updateSegmentWithPhysics, ... } = useSimulation();`
      
      Ensure all props passed to children (Controls, RotorVisualizer, etc.) are mapped correctly.
    </instruction>
  </task>

  <task type="checkpoint:human-verify" name="verify_refactor">
    <instruction>
      Run `npm test` to ensure no regressions.
      Manually test:
      1. Edit a shaft segment (change diameter).
      2. Verify physics update happens (RPM changes).
      3. Generate new data.
    </instruction>
  </task>
</tasks>

<verification>
- `npm test` passes.
- Application behaves identically to before, but App.tsx code is significantly smaller.
</verification>

<success_criteria>
- `src/hooks/useSimulation.ts` exists and encapsulates logic.
- `App.tsx` imports and uses the hook.
- "God Object" complexity reduced.
</success_criteria>

<output>
- src/hooks/useSimulation.ts
- src/hooks/useSimulation.test.ts
- Updated src/App.tsx
</output>
