---
phase: 01-foundation-and-refactor
plan: 04
type: execute
wave: 3
depends_on: ["03"]
files_modified:
  - src/utils/fileStorage.ts
  - src/utils/fileStorage.test.ts
  - src/components/Controls.tsx
  - src/App.tsx
autonomous: true
user_setup: []
---

<objective>
Implement local data persistence (JSON import/export) to allow saving and loading simulation configurations (Requirement DATA-01).
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
@./.gemini/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@src/types.ts
@src/components/Controls.tsx
</context>

<tasks>
  <task type="auto" name="create_storage_utils">
    <file_path>src/utils/fileStorage.ts</file_path>
    <instruction>
      Create utility functions:
      - `exportSimulation(data: SimulationData, filename?: string)`: Triggers browser download of JSON file.
      - `importSimulation(file: File): Promise<SimulationData>`: Reads JSON file, validates it (basic structure check), and returns data.
    </instruction>
  </task>

  <task type="auto" name="test_storage_utils">
    <file_path>src/utils/fileStorage.test.ts</file_path>
    <instruction>
      Unit test `importSimulation` logic (mocking FileReader).
    </instruction>
  </task>

  <task type="auto" name="update_controls_ui">
    <file_path>src/components/Controls.tsx</file_path>
    <instruction>
      Add "Save" and "Load" buttons to the Controls component (e.g., in the header or near Generate).
      - Save: calls `onSave`.
      - Load: hidden file input triggered by "Load" button, calls `onLoad` with file.
      
      Define `onSave` and `onLoad` props in Controls interface.
    </instruction>
  </task>

  <task type="auto" name="connect_app">
    <file_path>src/App.tsx</file_path>
    <instruction>
      Connect `Controls` props to logic:
      - `onSave`: Call `exportSimulation(data)`.
      - `onLoad`: Call `importSimulation(file)` then `setData(loadedData)`.
      
      (Note: `setData` should be exposed from `useSimulation` hook created in Plan 03).
    </instruction>
  </task>

  <task type="checkpoint:human-verify" name="verify_persistence">
    <instruction>
      1. Generate or modify a rotor.
      2. Click "Save" -> Verify .json file downloads.
      3. Refresh page (reset to default).
      4. Click "Load" -> Select file -> Verify state restores.
    </instruction>
  </task>
</tasks>

<verification>
- Can save simulation state to JSON.
- Can load simulation state from JSON.
</verification>

<success_criteria>
- `src/utils/fileStorage.ts` exists.
- UI elements for Save/Load exist.
- Functionality verified in browser.
</success_criteria>

<output>
- src/utils/fileStorage.ts
- Updated src/components/Controls.tsx
- Updated src/App.tsx
</output>
